<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>OGRE-Next: Multithreaded Shader Compilation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="ogre_style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="ogre-logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">OGRE-Next
   &#160;<span id="projectnumber">4.0.0unstable</span>
   </div>
   <div id="projectbrief">Object-Oriented Graphics Rendering Engine</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('_hlms_threading.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Multithreaded Shader Compilation </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_manual_Rendering_HlmsThreading"></a> Starting OgreNext 4.0, the following features were added:</p><ul>
<li>Multithreaded Hlms shader generation.</li>
<li>Multithreaded shader compilation.</li>
<li>Multithreaded PSO generation.</li>
</ul>
<p>Actual support depends on RenderSystems &amp; CMake build settings. The user can call <code>Ogre::RenderSystems::supportsMultithreadedShaderCompilation</code> to query whether it is currently supported.</p>
<h1><a class="anchor" id="HlmsThreading_CMakeOptions"></a>
CMake Options</h1>
<p>The CMake option <code>OGRE_SHADER_COMPILATION_THREADING_MODE</code> was added. This option is independent of <code>OGRE_CONFIG_THREAD_PROVIDER</code>.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Option   </th><th class="markdownTableHeadNone">Short Description   </th><th class="markdownTableHeadNone">Long Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0   </td><td class="markdownTableBodyNone">Disabled.   </td><td class="markdownTableBodyNone">No shader compilation will be supported.<br  />
 The macro OGRE_SHADER_THREADING_BACKWARDS_COMPATIBLE_API will be defined thus the class Hlms will provide setProperty, getProperty, unsetProperty and co. API calls that do not ask for a tid argument.<br  />
 If the user calls the functions that ask for a tid argument, <b>the value tid holds must be 0</b>.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Use compatible API.<br  />
Enable only if supported by compiler and OS.<br  />
Default setting.   </td><td class="markdownTableBodyNone">The macro OGRE_SHADER_THREADING_BACKWARDS_COMPATIBLE_API will be defined thus the class Hlms will provide setProperty, getProperty, unsetProperty and co. API calls that do not ask for a tid argument.<br  />
<br  />
OgreNext will use compiler-assisted TLS (Thread Local Storage) to automatically determine the tid (thread ID) value. In practice OgreNext will <b>only</b> use TLS (and hence enabling multithreading) in fully static builds (i.e. CMake option <code>OGRE_STATIC = TRUE</code>), and disable it in dynamic library builds.<br  />
<br  />
 If <code>OGRE_STATIC = TRUE</code> then:<br  />
 - If the user calls the functions that ask for a tid argument, the tid value will be used.<br  />
 - If the user calls the functions that don't ask for a tid argument, OgreNext will use TLS to determine the correct tid value.<br  />
<br  />
If <code>OGRE_STATIC = FALSE</code> the behavior is the same as Disabled.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">2   </td><td class="markdownTableBodyNone">Force-enable.   </td><td class="markdownTableBodyNone">The macro OGRE_SHADER_THREADING_BACKWARDS_COMPATIBLE_API will <b>not</b> be defined.<br  />
 The user must always call setProperty, getProperty and co. that ask for a tid argument.   </td></tr>
</table>
<p>The default option is 1 because it allows to provide Multithreaded support when possible, while providing backwards-compatible API functions that make porting from OgreNext 3.0 easier. Make sure to read <a class="el" href="_ogre40_changes.html#Ogre40Changes_PortingTips">Porting tips (from &lt;= 3.0)</a> section.</p>
<p><b>New users are encouraged to use option 2 instead</b> to make sure they can maximize performance and avoid confusion over which setProperty, getProperty &amp; co. functions they should use.</p>
<dl class="section note"><dt>Note</dt><dd>This option will not exist forever. See <a class="el" href="_deprecation_plan.html">Deprecation Plan</a>.</dd></dl>
<h1><a class="anchor" id="HlmsThreading_tidArgument"></a>
The tid (Thread ID) argument</h1>
<p>Many functions provide or ask for a tid argument. When you're asked for a tid argument, you must pass it along. e.g.:</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span><a class="code" href="namespace_ogre.html">Ogre</a></div>
<div class="line">{</div>
<div class="line">    <span class="keyword">class </span>MyHlmsListener : <span class="keyword">public</span> HlmsListener</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">void</span> propertiesMergedPreGenerationStep(</div>
<div class="line">            Hlms *hlms, <span class="keyword">const</span> HlmsCache &amp;passCache, <span class="keyword">const</span> <a class="code" href="group___resources.html#ga1d333e3b1280899cce855c563f200938">HlmsPropertyVec</a> &amp;renderableCacheProperties,</div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="group___resources.html#ga7308171d42bf5b86adda94adc5d30f03">PiecesMap</a> renderableCachePieces[<a class="code" href="group___general.html#gga7049ce296bb4883feab25251d3865035a0bf893209b217d59e15abaf48092d132">NumShaderTypes</a>], <span class="keyword">const</span> <a class="code" href="group___resources.html#ga1d333e3b1280899cce855c563f200938">HlmsPropertyVec</a> &amp;properties,</div>
<div class="line">            <span class="keyword">const</span> QueuedRenderable &amp;queuedRenderable, <span class="keywordtype">size_t</span> tid )<span class="keyword"> override</span></div>
<div class="line"><span class="keyword">        </span>{</div>
<div class="line">            <span class="comment">// We pass along the tid value.</span></div>
<div class="line">            int32_t propertyValue = hlms-&gt;getProperty( <span class="stringliteral">&quot;MyPropertyName&quot;</span>, tid );</div>
<div class="line">        }</div>
<div class="line">    };</div>
<div class="line">}</div>
<div class="ttc" id="agroup___general_html_gga7049ce296bb4883feab25251d3865035a0bf893209b217d59e15abaf48092d132"><div class="ttname"><a href="group___general.html#gga7049ce296bb4883feab25251d3865035a0bf893209b217d59e15abaf48092d132">Ogre::NumShaderTypes</a></div><div class="ttdeci">@ NumShaderTypes</div><div class="ttdef"><b>Definition:</b> OgreCommon.h:417</div></div>
<div class="ttc" id="agroup___resources_html_ga1d333e3b1280899cce855c563f200938"><div class="ttname"><a href="group___resources.html#ga1d333e3b1280899cce855c563f200938">Ogre::HlmsPropertyVec</a></div><div class="ttdeci">vector&lt; HlmsProperty &gt;::type HlmsPropertyVec</div><div class="ttdef"><b>Definition:</b> OgreHlmsCommon.h:168</div></div>
<div class="ttc" id="agroup___resources_html_ga7308171d42bf5b86adda94adc5d30f03"><div class="ttname"><a href="group___resources.html#ga7308171d42bf5b86adda94adc5d30f03">Ogre::PiecesMap</a></div><div class="ttdeci">map&lt; IdString, String &gt;::type PiecesMap</div><div class="ttdef"><b>Definition:</b> OgreHlmsCommon.h:169</div></div>
<div class="ttc" id="anamespace_ogre_html"><div class="ttname"><a href="namespace_ogre.html">Ogre</a></div><div class="ttdoc">bswapNN may be defined as macros in &lt;sys/endian.h&gt; or &lt;sys/bswap.h&gt;</div><div class="ttdef"><b>Definition:</b> OgreAndroidLogListener.h:35</div></div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>Whenever a function provides a tid you must assume it is being executed in a worker thread and thus take all the necessary precautions if your code accesses a shared resource (such as using a mutex, or using the tid parameter to index per-thread storage).</dd></dl>
<p>Other functions such as <a class="el" href="class_ogre_1_1_hlms_listener.html#ab0cc9cdfb4cc2eca0e06ba13a467c7e5" title="Called right before creating the pass cache, to allow the listener to add/remove properties.">Ogre::HlmsListener::preparePassHash</a> don't ask for a tid. This always means the function is being called from the main rendering thread unless stated otherwise by the documentation. When calling setProperty/getProperty &amp; co. you must use <code><a class="el" href="class_ogre_1_1_hlms.html#a3b41b85c9b51fe6794d25e95bd5ea31f" title="For single-threaded operations.">Ogre::Hlms::kNoTid</a></code>. e.g.:</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span><a class="code" href="namespace_ogre.html">Ogre</a></div>
<div class="line">{</div>
<div class="line">    <span class="keyword">class </span>MyHlmsListener : <span class="keyword">public</span> HlmsListener</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">void</span> preparePassHash( <span class="keyword">const</span> CompositorShadowNode *shadowNode, <span class="keywordtype">bool</span> casterPass,</div>
<div class="line">                                      <span class="keywordtype">bool</span> dualParaboloid, SceneManager *sceneManager, Hlms *hlms )<span class="keyword"> override</span></div>
<div class="line"><span class="keyword">        </span>{</div>
<div class="line">            <span class="comment">// We are not being provided a tid value. Therefore we must pass kNoTid instead.</span></div>
<div class="line">            int32_t propertyValue = hlms-&gt;getProperty( <span class="stringliteral">&quot;MyPropertyName&quot;</span>, <a class="code" href="class_ogre_1_1_hlms.html#a3b41b85c9b51fe6794d25e95bd5ea31f">Hlms::kNoTid</a> );</div>
<div class="line">        }</div>
<div class="line">    };</div>
<div class="line">}</div>
<div class="ttc" id="aclass_ogre_1_1_hlms_html_a3b41b85c9b51fe6794d25e95bd5ea31f"><div class="ttname"><a href="class_ogre_1_1_hlms.html#a3b41b85c9b51fe6794d25e95bd5ea31f">Ogre::Hlms::kNoTid</a></div><div class="ttdeci">static constexpr size_t kNoTid</div><div class="ttdoc">For single-threaded operations.</div><div class="ttdef"><b>Definition:</b> OgreHlms.h:147</div></div>
</div><!-- fragment --><p>If you're overriding the <a class="el" href="class_ogre_1_1_hlms.html" title="HLMS stands for &quot;High Level Material System&quot;.">Ogre::Hlms</a> class instead of <a class="el" href="class_ogre_1_1_hlms_listener.html" title="Listener that can be hooked to an Hlms implementation for extending it with custom code.">Ogre::HlmsListener</a>, the same rules apply. However you might override a function that is expected to be called from a worker thread but does not pass a tid value because the original Hlms implementations never needed it.</p>
<p>The rule is that anything called as part of Ogre::Hlms::createShaderCacheEntry needs a tid, while everything else is called from the main thread.</p>
<h2><a class="anchor" id="autotoc_md97"></a>
API when OGRE_SHADER_COMPILATION_THREADING_MODE = 1</h2>
<p>This option is used to facilitate porting from OgreNext 3.0.</p>
<p>All listener functions still provide a tid value. However OgreNext provides setProperty/getProperty functions that don't ask for one. Therefore it is possible to do this:</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span><a class="code" href="namespace_ogre.html">Ogre</a></div>
<div class="line">{</div>
<div class="line">    <span class="keyword">class </span>MyHlmsListener : <span class="keyword">public</span> HlmsListener</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">void</span> propertiesMergedPreGenerationStep(</div>
<div class="line">            Hlms *hlms, <span class="keyword">const</span> HlmsCache &amp;passCache, <span class="keyword">const</span> <a class="code" href="group___resources.html#ga1d333e3b1280899cce855c563f200938">HlmsPropertyVec</a> &amp;renderableCacheProperties,</div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="group___resources.html#ga7308171d42bf5b86adda94adc5d30f03">PiecesMap</a> renderableCachePieces[<a class="code" href="group___general.html#gga7049ce296bb4883feab25251d3865035a0bf893209b217d59e15abaf48092d132">NumShaderTypes</a>], <span class="keyword">const</span> <a class="code" href="group___resources.html#ga1d333e3b1280899cce855c563f200938">HlmsPropertyVec</a> &amp;properties,</div>
<div class="line">            <span class="keyword">const</span> QueuedRenderable &amp;queuedRenderable, <span class="keywordtype">size_t</span> tid )<span class="keyword"> override</span></div>
<div class="line"><span class="keyword">        </span>{</div>
<div class="line">            <span class="comment">// We are not passing along the tid value and it will compile if OGRE_SHADER_COMPILATION_THREADING_MODE &lt; 2.</span></div>
<div class="line">            <span class="comment">// If OGRE_SHADER_COMPILATION_THREADING_MODE == 2, this line will not compile.</span></div>
<div class="line">            int32_t propertyValue = hlms-&gt;getProperty( <span class="stringliteral">&quot;MyPropertyName&quot;</span> );</div>
<div class="line"> </div>
<div class="line">            <span class="comment">// This is always possible, which facilitates porting from OgreNext 3.0.</span></div>
<div class="line">            int32_t propertyValue2 = hlms-&gt;getProperty( <span class="stringliteral">&quot;MyPropertyName&quot;</span>, tid );</div>
<div class="line">        }</div>
<div class="line">    };</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md98"></a>
How does threaded Hlms work?</h1>
<p>Hlms shaders are not randomly generated at any time from anywhere. It's not chaotic.</p>
<p>Shader generation requests can originate from 3 locations:</p>
<ol type="1">
<li>We're rendering. i.e. we're inside a <code>render_scene</code> compositor pass.</li>
<li>We're warming up the cache. i.e. we're inside a <code>warm_up</code> compositor pass.</li>
<li>We're loading the <a class="el" href="class_ogre_1_1_hlms_disk_cache.html" title="This class allows saving the current state of an Hlms to disk: both its compiled shaders with source ...">Ogre::HlmsDiskCache</a>. i.e. we're inside <a class="el" href="class_ogre_1_1_hlms_disk_cache.html#a8d635f3fac7d4242c1bc90f715b77f88">Ogre::HlmsDiskCache::applyTo</a>.</li>
</ol>
<p>The last two cases are specifically designed to compile shaders and/or generate PSOs. That's its main function.</p>
<p>Those routines will collect as many shader generation requests as possible and then batch-compile them in worker threads.</p>
<p>The first case however, <code>render_scene</code>, is a little different. Normally a render_scene in OgreNext 3.0 looks like this (e.g. see the source code for Ogre::RenderQueue::renderGL3) in pseudo-code and extremely simplified:</p>
<div class="fragment"><div class="line">startHlmsJobs();</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">for</span>( item : itemsToRender )</div>
<div class="line">{</div>
<div class="line">    Pso *pso = item.getPso();</div>
<div class="line">    <span class="keywordflow">if</span>( !pso )</div>
<div class="line">        pso = createNewPsoFor( item ); <span class="comment">// Note that two items may have the same PSO</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span>( pso != lastPso )</div>
<div class="line">        commandBuffer.addCommand( BindPso( pso ) );</div>
<div class="line">    commandBuffer.addCommand( DrawCall( item ) );</div>
<div class="line">    lastPso = pso;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// We can&#39;t execute all commands until we&#39;re done compiling all new PSOs.</span></div>
<div class="line">waitForHlmsJobs();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// All commands we added so far haven&#39;t actually been executed yet. Do that now.</span></div>
<div class="line">commandBuffer.executeAllCommands();</div>
</div><!-- fragment --><p>When OgreNext is compiling in parallel, the function <code>createNewPsoFor()</code> will actually return immediately with a valid Pso pointer, but it's not ready to be used yet.</p>
<p>That's why we must call <code>waitForHlmsJobs()</code> before calling <code>executeAllCommands()</code>.</p>
<p>Therefore OgreNext will process and iterate through many Items while worker threads compile shaders that were seen for the first time.</p>
<p>With a bit of luck, if the worker threads finish compiling before we reach <code>waitForHlmsJobs()</code> then there will be no stalls at all. If not, then the wait has likely reduced by a little. Furthermore, if multiple new PSOs are encountered, they will be delivered to different worker threads thus compiling in parallel.</p>
<h2><a class="anchor" id="autotoc_md99"></a>
What is the range of tid argument?</h2>
<p>The range is <code>[0; num_threads)</code>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="manual.html">Manual</a></li><li class="navelem"><a class="el" href="_rendering.html">Rendering</a></li><li class="navelem"><a class="el" href="hlms.html">HLMS: High Level Material System</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
