<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>OGRE-Next: ParticleFX2 / Particle System 2 Documentation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="ogre_style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="ogre-logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">OGRE-Next
   &#160;<span id="projectnumber">4.0.0unstable</span>
   </div>
   <div id="projectbrief">Object-Oriented Graphics Rendering Engine</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('_particle_system2.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">ParticleFX2 / Particle System 2 Documentation </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#ParticleSystem2ReasonsPFX2">Reasons to use ParticleFX2</a></li>
<li class="level1"><a href="#ParticleSystem2ReasonsNotPFX2">Reasons not to use ParticleFX2</a></li>
<li class="level1"><a href="#ParticleSystem2DiffWithPFX2">Differences with ParticleFX2</a><ul><li class="level2"><a href="#ParticleSystem2DistToCamera">Distance to Camera</a></li>
</ul>
</li>
<li class="level1"><a href="#ParticleSystem2Oit">Using OIT (Order Independent Transparency)</a><ul><li class="level2"><a href="#AlphaHashingBlueNoiseSetup">Alpha Hashing: Blue Noise vs White Noise</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md78">Thread Safe RandomValueProvider</a></li>
<li class="level1"><a href="#autotoc_md79">New settings</a></li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_manual_Plugins_ParticleSystem2"></a></p>
<p>A new plugin called ParticleFX2 was built based on ParticleFX (from now on we'll refer to the latter as ParticleFX1).</p>
<p>In many ways it is backwards compatible with scripts written for ParticleFX, but there are a few differences. <b>It is not meant to be a complete replacement, therefore it does not deprecate the older ParticleFX plugin</b>.</p>
<p><b>Note that it is possible to use both ParticleFX1 &amp; ParticleFX2 plugins at the same time</b>.</p>
<h1><a class="anchor" id="ParticleSystem2ReasonsPFX2"></a>
Reasons to use ParticleFX2</h1>
<ul>
<li>Code is SIMD &amp; Cache friendly.</li>
<li>Particle simulation is multithreaded.</li>
<li>Requires lower CPU to GPU Bandwidth when rendered from multiple camera angles.</li>
<li>Performance is paramount.</li>
<li>You want to have a lot of ParticleSystem2 instances and or...</li>
<li>You want to simulate a large number of particles (whether it's one instance with many particles, or many instances with few or many particles).</li>
<li>Uses the v2 buffer interface which guarantees no stalls.</li>
<li>You want particles that can cast shadows or use PBS lighting and normal maps.<ul>
<li>Note that due to the nature of point sprites, PBS lighting/normal maps may not always look good unless extra care is given to the normal map.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="ParticleSystem2ReasonsNotPFX2"></a>
Reasons not to use ParticleFX2</h1>
<ul>
<li>Particle Render order is very important.<ul>
<li>PFX2 does not sort particles.</li>
</ul>
</li>
<li>The particle system uses <code>local_space</code>.</li>
<li>The particle system emits emitters.</li>
<li>The particle system uses <code>billboard_origin</code>.<ul>
<li>Only <code>center</code> origin is currently supported. Although this can be improved in the future.</li>
</ul>
</li>
<li>You are using low level materials to render the particle.<ul>
<li>PFX2 uses advanced modern rendering techniques to generate geometry procedurally in the Vertex Shader. There are no vertex buffers involved.</li>
</ul>
</li>
<li>You need to alter the instance's parameter often. e.g. you want to add/remove emitters or affectors for a particular instance.<ul>
<li>In PFX2 all instances share the same set of emitters and affectors.</li>
<li>You can use <code>ParticleSystemDef::clone</code> to clone the system definition and alter the definition.</li>
</ul>
</li>
<li>When a particle system dies, you absolutely need its particles to suddenly disappear<ul>
<li>PFX2 particles are <em><b>not</b></em> linked to the instance that created them. Therefore if an instance is destroyed, the particles it emitted will eventually fade when their <code>time_to_live</code> expires.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="ParticleSystem2DiffWithPFX2"></a>
Differences with ParticleFX2</h1>
<ul>
<li>Quota is shared by all instances<ul>
<li>In PFX1, a quota of 100 means each instance is not allowed to emit more than 100 particles. Thus if you had 500 instances, you could have up to 100 * 500 = 50.000 particles.</li>
<li>In PFX2, a quota of 100 means all instances are not allowed to emit more than 100 particles in total. Thus regardless of the number of instances, you could never have more than 100 particles.</li>
</ul>
</li>
<li>ParticleFX2 does not sort particles.<ul>
<li>You can use OIT (Order Independent Transparency) algorithms to workaround this limitation.</li>
<li>All instances sharing the same <code>ParticleSystemDef</code> can use <code>ParticleSystemDef::setRenderQueueGroup</code> &amp; <code>ParticleSystemDef::setRenderQueueSubGroup</code> though.</li>
</ul>
</li>
<li>Distance to camera, controlled by <code>ParticleSystemManager2::setCameraPosition</code>, is very important for the simulation and the quota.</li>
</ul>
<p>Quota values need to be adjusted. The rationale is that the quota should reflect the maximum amount of particles the system supports and still maintain a reasonable framerate.</p>
<p>In PFX1, the particle count could blow out of proportions as the number of instances is potentially infinite. In PFX2, if the system can only simulate up to 10.000 particles before tanking performance, then the quota should be 10.000.</p>
<p>This also allows scaling to difference systems by having an Option presented to the user (e.g. Particle Count: Low, Medium, High)</p>
<h2><a class="anchor" id="ParticleSystem2DistToCamera"></a>
Distance to Camera</h2>
<p>Because <b>the shared quota is a precious resource</b>, every frame all instances are sorted by distance to camera.</p>
<p>The ones closer are given priority to emit. If the shared quota is exhausted, that means that far away instances won't be able to emit more. If they had emitted any particles in the past, those particles will eventually die when their <code>time_to_live</code> expires.</p>
<p>Every frame you must call:</p>
<div class="fragment"><div class="line"><a class="code" href="class_ogre_1_1_camera.html">Ogre::Camera</a> *camera = <span class="comment">/*...*/</span>;</div>
<div class="line"><a class="code" href="class_ogre_1_1_scene_manager.html">Ogre::SceneManager</a> *sceneManager = <span class="comment">/*...*/</span>;</div>
<div class="line">sceneManager-&gt;<a class="code" href="class_ogre_1_1_scene_manager.html#a0632d16c0e9df6c44f98cf1574abe113">getParticleSystemManager2</a>()-&gt;<a class="code" href="class_ogre_1_1_particle_system_manager2.html#a8cfc44a25d757598ccdb16e5b5e79ca4">setCameraPosition</a>( camera-&gt;<a class="code" href="class_ogre_1_1_camera.html#a2b34d86631e2376f5e0aa317e2e817a4">getDerivedPosition</a>() );</div>
<div class="ttc" id="aclass_ogre_1_1_camera_html"><div class="ttname"><a href="class_ogre_1_1_camera.html">Ogre::Camera</a></div><div class="ttdoc">A viewpoint from which the scene will be rendered.</div><div class="ttdef"><b>Definition:</b> OgreCamera.h:101</div></div>
<div class="ttc" id="aclass_ogre_1_1_camera_html_a2b34d86631e2376f5e0aa317e2e817a4"><div class="ttname"><a href="class_ogre_1_1_camera.html#a2b34d86631e2376f5e0aa317e2e817a4">Ogre::Camera::getDerivedPosition</a></div><div class="ttdeci">const Vector3 &amp; getDerivedPosition() const</div><div class="ttdoc">Gets the derived position of the camera, including any translation inherited from a node attachment a...</div></div>
<div class="ttc" id="aclass_ogre_1_1_particle_system_manager2_html_a8cfc44a25d757598ccdb16e5b5e79ca4"><div class="ttname"><a href="class_ogre_1_1_particle_system_manager2.html#a8cfc44a25d757598ccdb16e5b5e79ca4">Ogre::ParticleSystemManager2::setCameraPosition</a></div><div class="ttdeci">void setCameraPosition(const Vector3 &amp;camPos)</div><div class="ttdoc">All instances are sorted every frame to their distance to camera.</div><div class="ttdef"><b>Definition:</b> OgreParticleSystemManager2.h:218</div></div>
<div class="ttc" id="aclass_ogre_1_1_scene_manager_html"><div class="ttname"><a href="class_ogre_1_1_scene_manager.html">Ogre::SceneManager</a></div><div class="ttdoc">Manages the organisation and rendering of a 'scene' i.e.</div><div class="ttdef"><b>Definition:</b> OgreSceneManager.h:235</div></div>
<div class="ttc" id="aclass_ogre_1_1_scene_manager_html_a0632d16c0e9df6c44f98cf1574abe113"><div class="ttname"><a href="class_ogre_1_1_scene_manager.html#a0632d16c0e9df6c44f98cf1574abe113">Ogre::SceneManager::getParticleSystemManager2</a></div><div class="ttdeci">ParticleSystemManager2 * getParticleSystemManager2()</div><div class="ttdef"><b>Definition:</b> OgreSceneManager.h:1691</div></div>
</div><!-- fragment --><p>Only one camera position per SceneManager is supported. If rendering from multiple camera positions, consider using the most relevant position for the simulation.</p>
<p>This value does not control rendering. It's not instantaneous. It merely tells the simulation which systems should be prioritized for emission for this frame.</p>
<h1><a class="anchor" id="ParticleSystem2Oit"></a>
Using OIT (Order Independent Transparency)</h1>
<p>OgreNext currently supports <a href="https://casual-effects.com/research/Wyman2017Hashed/index.html">alpha hashing</a> to render transparents without having to care about render order.</p>
<p>Combined with <a href="https://bgolus.medium.com/anti-aliased-alpha-test-the-esoteric-alpha-to-coverage-8b177335ae4f">alpha to coverage (A2C)</a> it can produce very good results.</p>
<p>An advantage of alpha hashing + A2C is that it works fine with depth writes on.</p>
<p>The main downside however, is the "grainy" or "noisy" effect due to the nature of the effect.</p>
<p>The basic layman version is that when the alpha is 0.25, that means we simply (on average) render 1 pixel at 100% opacity and skip the rendering the next 3 pixels.</p>
<p>The material definition looks like this:</p>
<div class="fragment"><div class="line">hlms Particle/SmokeUnlit unlit</div>
<div class="line">{</div>
<div class="line">    depth_write on    // Note: It&#39;s on by default</div>
<div class="line">    cull_mode   none</div>
<div class="line">    diffuse_map smoke.png</div>
<div class="line"> </div>
<div class="line">    alpha_hash        yes</div>
<div class="line">    alpha_to_coverage msaa_only</div>
<div class="line">}</div>
</div><!-- fragment --><p>The key settings are:</p>
<ul>
<li><code>alpha_hash</code>: Enables the setting in question</li>
<li><code>alpha_to_coverage</code>: Enables A2C only if the render target we're rendering to is MSAA. A2C will be combined with alpha hashing for a better quality. The Render Target must be MSAA to make use of this. Best results are with 4x MSAA.</li>
<li><code>depth_write</code>: Normally transparents are recommended to disable depth writes. Thus an old material using alpha or additive blending may have it disabled. Remember to enable it back if you use alpha hashing.</li>
</ul>
<p><b>Alpha Blending (wrong sort):</b></p>
<p><img src="AlphaBlend.jpg" alt="" class="inline"/></p>
<p><b>Alpha Hashing:</b></p>
<p><img src="AlphaHash.jpg" alt="" class="inline"/></p>
<p><b>Alpha Hashing + A2C (4x MSAA):</b></p>
<p><img src="AlphaHashA2C.jpg" alt="" class="inline"/></p>
<p>Note that the noise may look terrible but it quite different in motion. See <code>Samples/2.0/ApiUsage/ParticleFX2</code> sample.</p>
<h2><a class="anchor" id="AlphaHashingBlueNoiseSetup"></a>
Alpha Hashing: Blue Noise vs White Noise</h2>
<p>The Hlms implementation provide both blue noise and white noise implementations.</p>
<p>Blue Noise requires you include the file <code>LDR_R_0.png</code> and during initialization time call:</p>
<div class="fragment"><div class="line"><span class="keywordflow">try</span></div>
<div class="line">{</div>
<div class="line">    mRoot-&gt;getHlmsManager()-&gt;loadBlueNoise();</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">catch</span>( <a class="code" href="class_ogre_1_1_file_not_found_exception.html">Ogre::FileNotFoundException</a> &amp;e )</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="class_ogre_1_1_log_manager.html#a902232428113a662c9edef05660d5b27">Ogre::LogManager::getSingleton</a>().<a class="code" href="class_ogre_1_1_log_manager.html#a0c4faae4a0fbe6f8df7583cfa4c63b52">logMessage</a>( e.<a class="code" href="class_ogre_1_1_exception.html#afac7bd5132f02a3a4fe002aa66e3ccda">getFullDescription</a>(), <a class="code" href="group___general.html#gga124456c1616299612ac9f46e7d69268da5210f9fef7f2093878f02f2757606f33">Ogre::LML_CRITICAL</a> );</div>
<div class="line">    <a class="code" href="class_ogre_1_1_log_manager.html#a902232428113a662c9edef05660d5b27">Ogre::LogManager::getSingleton</a>().<a class="code" href="class_ogre_1_1_log_manager.html#a0c4faae4a0fbe6f8df7583cfa4c63b52">logMessage</a>(</div>
<div class="line">        <span class="stringliteral">&quot;WARNING: Blue Noise textures could not be loaded.&quot;</span>, <a class="code" href="group___general.html#gga124456c1616299612ac9f46e7d69268da5210f9fef7f2093878f02f2757606f33">Ogre::LML_CRITICAL</a> );</div>
<div class="line">}</div>
<div class="ttc" id="aclass_ogre_1_1_exception_html_afac7bd5132f02a3a4fe002aa66e3ccda"><div class="ttname"><a href="class_ogre_1_1_exception.html#afac7bd5132f02a3a4fe002aa66e3ccda">Ogre::Exception::getFullDescription</a></div><div class="ttdeci">virtual const String &amp; getFullDescription() const</div><div class="ttdoc">Returns a string with the full description of this error.</div></div>
<div class="ttc" id="aclass_ogre_1_1_file_not_found_exception_html"><div class="ttname"><a href="class_ogre_1_1_file_not_found_exception.html">Ogre::FileNotFoundException</a></div><div class="ttdef"><b>Definition:</b> OgreException.h:207</div></div>
<div class="ttc" id="aclass_ogre_1_1_log_manager_html_a0c4faae4a0fbe6f8df7583cfa4c63b52"><div class="ttname"><a href="class_ogre_1_1_log_manager.html#a0c4faae4a0fbe6f8df7583cfa4c63b52">Ogre::LogManager::logMessage</a></div><div class="ttdeci">void logMessage(const String &amp;message, LogMessageLevel lml=LML_NORMAL, bool maskDebug=false)</div><div class="ttdoc">Log a message to the default log.</div></div>
<div class="ttc" id="aclass_ogre_1_1_log_manager_html_a902232428113a662c9edef05660d5b27"><div class="ttname"><a href="class_ogre_1_1_log_manager.html#a902232428113a662c9edef05660d5b27">Ogre::LogManager::getSingleton</a></div><div class="ttdeci">static LogManager &amp; getSingleton()</div><div class="ttdoc">Override standard Singleton retrieval.</div></div>
<div class="ttc" id="agroup___general_html_gga124456c1616299612ac9f46e7d69268da5210f9fef7f2093878f02f2757606f33"><div class="ttname"><a href="group___general.html#gga124456c1616299612ac9f46e7d69268da5210f9fef7f2093878f02f2757606f33">Ogre::LML_CRITICAL</a></div><div class="ttdeci">@ LML_CRITICAL</div><div class="ttdef"><b>Definition:</b> OgreLog.h:69</div></div>
</div><!-- fragment --><p>When blue noise is not available, OgreNext will automatically fallback to a white noise implementation. Which one looks better is a bit subjective.</p>
<h1><a class="anchor" id="autotoc_md78"></a>
Thread Safe RandomValueProvider</h1>
<p>PFX2 relies on <code>Math::UnitRandom</code> being thread safe.</p>
<p>If you've registered a custom random provider via <code>Math::SetRandomValueProvider</code>, then make sure <code>RandomValueProvider::getRandomUnit</code> is thread safe (e.g. use TLS).</p>
<h1><a class="anchor" id="autotoc_md79"></a>
New settings</h1>
<p>scaler TBD </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="manual.html">Manual</a></li><li class="navelem"><a class="el" href="_plugins.html">Plugins</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
